worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Cache for HLS
    proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=hls_cache:10m max_size=1g;
    
    server {
        listen 8080;
        server_name _;
        
        # ========== HLS STREAMS ==========
        
        # HLS Playlists
        location ~ ^/hls/(.+)/(playlist\.m3u8)$ {
            alias /tmp/hls/$1/$2;
            
            add_header Cache-Control "no-cache";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Range, Origin, Accept-Encoding";
            
            # CORS preflight
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, OPTIONS";
                add_header Access-Control-Allow-Headers "Range, Origin, Accept-Encoding";
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type "text/plain charset=UTF-8";
                add_header Content-Length 0;
                return 204;
            }
        }
        
        # HLS Segments
        location ~ ^/hls/(.+)/(segment_.+\.ts)$ {
            alias /tmp/hls/$1/$2;
            
            add_header Cache-Control "public, max-age=86400";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # ========== HTML PLAYER ==========
        location /player/art-aflam {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>ART Aflam - HLS Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { margin: 0; padding: 20px; background: #111; color: white; font-family: Arial; }
        .container { max-width: 800px; margin: 0 auto; }
        video { width: 100%; background: black; margin-top: 20px; }
        .info { background: #222; padding: 15px; margin-top: 20px; border-radius: 5px; }
        .status { padding: 10px; background: #2a2a2a; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ ART Aflam - HLS Stream</h1>
        
        <div class="status" id="status">
            Loading stream...
        </div>
        
        <video id="video" controls></video>
        
        <div class="info">
            <h3>Stream Information:</h3>
            <p><strong>Format:</strong> HLS (HTTP Live Streaming)</p>
            <p><strong>Compatibility:</strong> iOS, Android, Windows, Mac, Smart TVs</p>
            <p><strong>URL:</strong> <code id="streamUrl">/hls/art-aflam/playlist.m3u8</code></p>
            <button onclick="copyUrl()">Copy Stream URL</button>
        </div>
    </div>
    
    <script>
        const video = document.getElementById("video");
        const statusDiv = document.getElementById("status");
        const streamUrl = "/hls/art-aflam/playlist.m3u8";
        
        if (Hls.isSupported()) {
            const hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90
            });
            
            hls.loadSource(streamUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                statusDiv.innerHTML = "‚úÖ Stream loaded successfully";
                statusDiv.style.background = "#2e7d32";
                video.play();
            });
            
            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            statusDiv.innerHTML = "‚ùå Network error - trying to recover...";
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            statusDiv.innerHTML = "‚ùå Media error - recovering...";
                            hls.recoverMediaError();
                            break;
                        default:
                            statusDiv.innerHTML = "‚ùå Fatal error - cannot recover";
                            hls.destroy();
                            break;
                    }
                }
            });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            // Safari native HLS support
            video.src = streamUrl;
            video.addEventListener("loadedmetadata", function() {
                statusDiv.innerHTML = "‚úÖ Stream loaded (Native HLS)";
                statusDiv.style.background = "#2e7d32";
                video.play();
            });
        } else {
            statusDiv.innerHTML = "‚ùå HLS not supported in this browser";
            statusDiv.style.background = "#c62828";
        }
        
        function copyUrl() {
            navigator.clipboard.writeText(window.location.origin + streamUrl);
            alert("Stream URL copied to clipboard!");
        }
    </script>
</body>
</html>';
        }
        
        # ========== PLAYLIST PAGE ==========
        location /playlist {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>HLS Playlists</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .playlist-item { padding: 15px; margin: 10px 0; background: #f5f5f5; }
        code { background: #eee; padding: 2px 5px; }
    </style>
</head>
<body>
    <h1>üì∫ Available HLS Streams</h1>
    
    <div class="playlist-item">
        <h3>ART Aflam</h3>
        <p><strong>HLS Playlist:</strong> <code>/hls/art-aflam/playlist.m3u8</code></p>
        <p><a href="/player/art-aflam">‚ñ∂Ô∏è Open Player</a></p>
        <p><a href="/hls/art-aflam/playlist.m3u8" download>üì• Download M3U8</a></p>
    </div>
    
    <h2>How to use:</h2>
    <ul>
        <li><strong>VLC:</strong> Media ‚Üí Open Network ‚Üí Paste HLS URL</li>
        <li><strong>iOS/Android:</strong> Use VLC app or MX Player</li>
        <li><strong>Smart TV:</strong> Use built-in media player</li>
    </ul>
</body>
</html>';
        }
        
        # ========== API ENDPOINTS ==========
        location /api/ {
            proxy_pass http://127.0.0.1:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        # ========== MAIN PAGE ==========
        location / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DASH to HLS Converter</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
               background: linear-gradient(135deg, #1a237e 0%, #311b92 100%); color: white; 
               min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; padding: 40px 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #ffd600; }
        .card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 25px; 
                margin: 20px 0; border: 1px solid rgba(255,255,255,0.2); }
        .stream-card { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .stream-info { padding: 15px; }
        .stream-player { background: black; border-radius: 5px; overflow: hidden; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; 
               background: #4CAF50; color: white; border-radius: 5px; text-decoration: none; 
               margin: 5px; border: none; cursor: pointer; }
        .btn:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; }
        .status { display: inline-block; padding: 5px 10px; border-radius: 3px; 
                  font-size: 0.9em; }
        .status-active { background: #4CAF50; }
        .status-inactive { background: #f44336; }
        @media (max-width: 768px) { 
            .stream-card { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ DASH to HLS Converter</h1>
            <p>Convert protected DASH streams to universal HLS format</p>
        </header>
        
        <div class="card stream-card">
            <div class="stream-info">
                <h2>ART Aflam</h2>
                <p>Arabic movies and series channel</p>
                
                <div style="margin: 15px 0;">
                    <span class="status status-active" id="streamStatus">‚óè Live</span>
                    <span style="margin-left: 10px; opacity: 0.8;">HLS Format</span>
                </div>
                
                <div style="margin: 20px 0;">
                    <a href="/player/art-aflam" class="btn">
                        <span>‚ñ∂Ô∏è</span>
                        <span>Open Player</span>
                    </a>
                    
                    <a href="/hls/art-aflam/playlist.m3u8" class="btn btn-secondary" download>
                        <span>üì•</span>
                        <span>Download M3U8</span>
                    </a>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <h4>Stream URLs:</h4>
                    <p><strong>HLS:</strong> <code id="hlsUrl">/hls/art-aflam/playlist.m3u8</code></p>
                    <p><strong>Player:</strong> <code>/player/art-aflam</code></p>
                </div>
            </div>
            
            <div class="stream-player">
                <video style="width: 100%; height: 100%;" controls poster="https://via.placeholder.com/300x169/333/fff?text=ART+Aflam">
                    <source src="/hls/art-aflam/playlist.m3u8" type="application/x-mpegURL">
                    Your browser does not support HLS streaming.
                </video>
            </div>
        </div>
        
        <div class="card">
            <h3>üì± Compatibility</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div>
                    <h4>‚úÖ Supported</h4>
                    <ul>
                        <li>iOS (Safari)</li>
                        <li>Android (Chrome)</li>
                        <li>Windows (Chrome, Edge)</li>
                        <li>macOS (Safari)</li>
                        <li>Smart TVs</li>
                    </ul>
                </div>
                <div>
                    <h4>üé¨ Players</h4>
                    <ul>
                        <li>VLC Media Player</li>
                        <li>MPV</li>
                        <li>MX Player</li>
                        <li>Infuse</li>
                        <li>All modern browsers</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Check stream status
        async function checkStatus() {
            try {
                const response = await fetch("/api/status");
                const data = await response.json();
                
                const statusEl = document.getElementById("streamStatus");
                if (data.channels["art-aflam"]?.active) {
                    statusEl.className = "status status-active";
                    statusEl.textContent = "‚óè Live";
                } else {
                    statusEl.className = "status status-inactive";
                    statusEl.textContent = "‚óè Offline";
                }
            } catch (error) {
                console.error("Status check failed:", error);
            }
        }
        
        // Update HLS URL with full path
        document.getElementById("hlsUrl").textContent = 
            window.location.origin + "/hls/art-aflam/playlist.m3u8";
        
        // Check status every 10 seconds
        checkStatus();
        setInterval(checkStatus, 10000);
    </script>
</body>
</html>';
        }
        
        # ========== HEALTH CHECK ==========
        location = /health {
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}
